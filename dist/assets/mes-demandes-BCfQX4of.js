import{r as w,j as e}from"./ui-BcXBiFQq.js";import{u as C}from"./useQuery-8TP4fbV0.js";import{a as M,u as E,e as k,f as D,g as I,B as i,P as h,p as n,C as z,b as S,h as T,d as q}from"./index-4tj7xDnq.js";import{f as B}from"./categories-x35FBw14.js";import{B as F}from"./badge-DPx3P7Eg.js";import{d as P}from"./services-B2lohCTD.js";import{C as A}from"./circle-alert-pDwW62sR.js";import{F as f}from"./file-text-BNKfLUIq.js";import{E as L}from"./eye-BdJQX-nQ.js";import{S as U}from"./square-pen-CxMuJ1DX.js";import{T as R}from"./trash-2-CYcXjteh.js";import"./vendor-D3F3s8fL.js";function Z(){const{user:a}=M(),[,l]=E(),[c,g]=w.useState(null),j=k(),{toast:o}=D(),{data:d=[],isLoading:m,error:x}=C({queryKey:["userMissions",a?.id],queryFn:async()=>{if(!a?.id)throw new Error("User ID manquant");console.log("🔍 Récupération des missions pour user.id:",a.id);try{const{missions:s}=await P.feed.getMissions();console.log("📊 Total missions récupérées:",s.length);const t=s.filter(r=>{const y=r.user_id||parseInt(r.userId||"0")||parseInt(r.clientId||"0"),N=parseInt(a.id.toString()),p=y===N;return p&&console.log("✅ Mission de l'utilisateur trouvée:",r.id,r.title),p});return console.log("✅ Missions utilisateur filtrées:",t.length),t}catch(s){throw console.error("❌ Erreur récupération missions utilisateur:",s),s}},enabled:!!a?.id,retry:2,retryDelay:1e3}),u=I({mutationFn:async s=>{const t=await fetch(`/api/missions/${s}`,{method:"DELETE"});if(!t.ok)throw new Error("Failed to delete mission");return t.json()},onSuccess:()=>{j.invalidateQueries({queryKey:["userMissions"]}),o({title:"Mission supprimée",description:"Votre mission a été supprimée avec succès."})},onError:s=>{o({title:"Erreur",description:"Impossible de supprimer la mission.",variant:"destructive"})}}),v=s=>{window.confirm("Êtes-vous sûr de vouloir supprimer cette mission ?")&&u.mutate(s)},b=s=>{const t={draft:{label:"Brouillon",variant:"secondary"},open:{label:"Ouverte",variant:"default"},published:{label:"Publiée",variant:"default"},in_progress:{label:"En cours",variant:"secondary"},completed:{label:"Terminée",variant:"outline"},cancelled:{label:"Annulée",variant:"destructive"}},r=t[s]||t.open;return e.jsx(F,{variant:r.variant,children:r.label})};return console.log("👤 User actuel:",{id:a?.id,role:a?.role,email:a?.email}),a?e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 sm:mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2",children:"Mes Demandes"}),e.jsx("p",{className:"text-base sm:text-lg text-gray-600",children:"Consultez et gérez vos projets publiés"})]}),e.jsxs(i,{onClick:()=>l(n.createMission),size:"lg",className:"w-full sm:w-auto",children:[e.jsx(h,{className:"mr-2 h-4 w-4 sm:h-5 sm:w-5"}),"Nouveau Projet"]})]}),m&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Chargement..."})]}),x&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(A,{className:"w-16 h-16 text-red-300 mx-auto mb-4"}),e.jsx("p",{className:"text-red-500 text-lg mb-4",children:"Erreur de chargement"}),e.jsx(i,{onClick:()=>window.location.reload(),variant:"outline",children:"Réessayer"})]}),!m&&!x&&e.jsx("div",{className:"space-y-6",children:d.length>0?d.map(s=>e.jsxs(z,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(S,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(T,{className:"text-xl",children:s.title}),b(s.status||"open")]}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base line-clamp-3",children:s.description})]}),e.jsxs("div",{className:"text-left sm:text-right",children:[e.jsx("div",{className:"text-xl font-bold text-primary",children:s.budgetDisplay}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:B(s.createdAt)})]})]})}),e.jsxs(q,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["Catégorie: ",s.category]}),e.jsxs("span",{children:["Lieu: ",s.location||"Non spécifié"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(f,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.bids?.length||0," offre",(s.bids?.length||0)!==1?"s":""]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>l(`/missions/${s.id}`),className:"flex items-center gap-1",children:[e.jsx(L,{className:"w-4 h-4"}),"Voir les offres"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>l(n.editMission(s.id?.toString()||"")),className:"flex items-center gap-1",children:[e.jsx(U,{className:"w-4 h-4"}),"Modifier"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>v(s.id),className:"flex items-center gap-1 text-red-600 hover:text-red-700",disabled:u.isPending,children:[e.jsx(R,{className:"w-4 h-4"}),"Supprimer"]})]})]}),s.bids&&s.bids.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Dernières offres reçues :"}),e.jsxs("div",{className:"space-y-2",children:[s.bids.slice(0,2).map(t=>e.jsxs("div",{className:"flex justify-between items-center text-sm bg-gray-50 p-2 rounded",children:[e.jsx("span",{className:"truncate flex-1",children:t.message||"Candidature soumise"}),e.jsx("span",{className:"font-medium text-primary ml-2",children:t.price||`${t.amount}€`})]},t.id)),s.bids.length>2&&e.jsxs("p",{className:"text-xs text-gray-500",children:["+",s.bids.length-2," autre",s.bids.length-2>1?"s":""," offre",s.bids.length-2>1?"s":""]})]})]})]})]},s.id)):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(f,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Vous n'avez pas encore créé de missions"}),e.jsxs(i,{onClick:()=>l(n.createMission),className:"bg-primary hover:bg-primary-dark text-white",children:[e.jsx(h,{className:"w-4 h-4 mr-2"}),"Créer ma première mission"]})]})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"Détails de la mission"}),e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>g(null),children:"✕"})]}),e.jsxs("p",{className:"text-gray-600",children:["Détails de la mission #",c]})]})})})]}):e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Connexion requise"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Veuillez vous connecter pour voir vos demandes"}),e.jsx(i,{onClick:()=>l("/"),children:"Retour à l'accueil"})]})})}export{Z as default};
